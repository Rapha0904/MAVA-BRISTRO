<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caixa - Mava Baristro</title>

<link rel="stylesheet" href="admin.css">
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>

/* =================== ESTILO DOS CARDS =================== */
.pedido-card{
    background:white;
    border-radius:14px;
    padding:20px;
    margin-bottom:18px;
    box-shadow:0 4px 14px rgba(0,0,0,0.12);
    border:2px solid var(--dourado);
    transition:.3s;
}

.pedido-card:hover{
    transform: translateY(-4px);
    box-shadow:0 6px 18px rgba(0,0,0,0.18);
}

.pedido-card h3{
    color:var(--azul);
    margin-bottom:6px;
    font-size:20px;
    font-weight:bold;
}

.pedido-card ul{
    padding-left:20px;
    margin-top:6px;
    font-size:15px;
}

/* TAGS */
.pay-tags{
    display:flex;
    gap:8px;
    font-size:14px;
    margin-top:10px;
    flex-wrap:wrap;
}

.pay-tag{
    padding:6px 12px;
    border-radius:50px;
    background:#f2f2f2;
    color:var(--azul);
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:bold;
    border:1px solid #ddd;
    transition:.2s;
}

.pay-tag:hover{
    background:#e8e8e8;
}

/* SELECT */
.pay-select{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #aaa;
    margin-top:10px;
}

/* BOTÃO */
.finalizar-btn{
    margin-top:15px;
    width:100%;
    padding:12px;
    background:var(--azul);
    color:var(--dourado);
    border:none;
    border-radius:12px;
    font-weight:bold;
    font-size:16px;
    cursor:pointer;
    transition:.25s;
}

.finalizar-btn:hover{
    background:#0d153b;
}
</style>
</head>

<body>

<!-- BOTÃO MENU MOBILE -->
<div class="menu-toggle" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">

    <h2>Mava Baristro</h2>

    <div class="menu-item" onclick="go('dashboard.html')">
        <i class="fas fa-chart-line"></i> Dashboard
    </div>

    <div class="menu-item" onclick="go('produtos.html')">
        <i class="fas fa-mug-hot"></i> Produtos
    </div>

    <div class="menu-item" onclick="go('cozinha.html')">
        <i class="fas fa-kitchen-set"></i> Cozinha
    </div>

    <div class="menu-item active" onclick="go('caixa.html')">
        <i class="fas fa-cash-register"></i> Caixa
    </div>

    <div class="menu-item" onclick="go('colaboradores.html')">
        <i class="fas fa-users"></i> Colaboradores
    </div>

    <div class="menu-item" onclick="logout()">
        <i class="fas fa-door-open"></i> Sair
    </div>
</div>

<!-- CONTEÚDO -->
<div class="content">

    <h1 class="title">
        <i class="fas fa-cash-register"></i> Pedidos do Caixa
    </h1>

    <div id="lista"></div>

</div>

<script type="module">

/* ============================= IMPORTAÇÃO CERTA ============================= */
import { auth, db } from "https://rapha0904.github.io/MAVA-BRISTRO/ADMINISTRATIVO/firebase.js";

import { onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import {
    ref,
    onValue,
    update
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

/* ============================= PROTEÇÃO ============================= */
onAuthStateChanged(auth, user => {
    if (!user) window.location.href = "../login.html";
});
window.logout = () => signOut(auth);

/* =================== PEGAR ID DO CLIENTE =================== */
let deviceId = localStorage.getItem("deviceId");
if (!deviceId) {
    deviceId = "dev-" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("deviceId", deviceId);
}

/* ============================= LISTAR PEDIDOS ============================= */
const lista = document.getElementById("lista");

onValue(ref(db, "pedidos"), snap => {

    lista.innerHTML = "";

    snap.forEach(item => {
        const p = item.val();
        const id = item.key;

        if (!p) return;

        if (p.status !== "pronto") return;
        if (p.deviceId !== deviceId) return;

        const hora = new Date(p.hora).toLocaleTimeString("pt-BR");

        lista.innerHTML += `
            <div class="pedido-card">
                <h3>Mesa ${p.mesa}</h3>
                <p><b>Horário:</b> ${hora}</p>

                <p><b>Itens:</b></p>
                <ul>${p.itens.map(i => `<li>${i}</li>`).join("")}</ul>

                <p style="margin-top:10px;font-size:16px;">
                    <b>Total:</b> R$ ${p.total.toFixed(2)}
                </p>

                <select id="pg-${id}" class="pay-select">
                    <option value="">Selecione a forma de pagamento</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="Cartão Débito">Cartão Débito</option>
                    <option value="Cartão Crédito">Cartão Crédito</option>
                    <option value="Vale Refeição">Vale Refeição</option>
                </select>

                <div class="pay-tags">
                    <span class="pay-tag"><i class="fas fa-money-bill-wave"></i> Dinheiro</span>
                    <span class="pay-tag"><i class="fas fa-qrcode"></i> Pix</span>
                    <span class="pay-tag"><i class="fas fa-credit-card"></i> Cartão</span>
                    <span class="pay-tag"><i class="fas fa-utensils"></i> VR</span>
                </div>

                <button class="finalizar-btn" onclick="finalizar('${id}')">
                    <i class="fas fa-check-circle"></i> Finalizar Pedido
                </button>
            </div>
        `;
    });
});

/* ============================= FINALIZAR PEDIDO ============================= */
window.finalizar = id => {

    const forma = document.getElementById("pg-" + id).value;

    if(!forma){
        alert("Selecione a forma de pagamento!");
        return;
    }

    update(ref(db, "pedidos/" + id), {
        status: "finalizado",
        pagamento: forma
    });

    alert("Pedido finalizado!");
};

</script>

<script>
function go(p){ window.location.href = p; }
function toggleMenu(){ document.getElementById("sidebar").classList.toggle("active"); }
</script>

</body>
</html>
