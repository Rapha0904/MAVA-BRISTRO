<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciar Colaboradores - Mava Baristro</title>

<link rel="stylesheet" href="admin.css">
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body>

<div class="menu-toggle" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">

    <h2>Mava Baristro</h2>

    <div class="menu-item" onclick="go('dashboard.html')">
        <i class="fas fa-chart-line"></i> Dashboard
    </div>

    <div class="menu-item" onclick="go('produtos.html')">
        <i class="fas fa-mug-hot"></i> Produtos
    </div>

    <div class="menu-item" onclick="go('cozinha.html')">
        <i class="fas fa-kitchen-set"></i> Cozinha
    </div>

    <div class="menu-item" onclick="go('caixa.html')">
        <i class="fas fa-cash-register"></i> Caixa
    </div>

    <div class="menu-item" onclick="go('mesas.html')">
        <i class="fas fa-chair"></i> Mesas
    </div>

    <div class="menu-item active" onclick="go('colaboradores.html')">
        <i class="fas fa-users"></i> Colaboradores
    </div>

    <div class="menu-item" onclick="logout()">
        <i class="fas fa-door-open"></i> Sair
    </div>

</div>

<!-- CONTEÚDO -->
<div class="content">

    <h1 class="title">Gerenciar Colaboradores</h1>

    <!-- APENAS ADMIN MASTER -->
    <div id="masterAviso" class="card" style="display:none;background:#ffe1e1;border-left:5px solid red;">
        <h2 style="color:red;">Acesso Negado</h2>
        <p>Somente o Administrador Master pode acessar esta página.</p>
    </div>

    <div id="conteudoMaster">

        <!-- CARD RESUMO (mini dashboard de colaboradores) -->
        <div class="card" id="card-resumo">
            <h2 style="color:var(--azul); margin-bottom:10px;">
                Visão geral dos colaboradores
            </h2>
            <p id="resumoTotal"><b>Total:</b> 0</p>
            <p id="resumoCozinha"><b>Cozinha:</b> 0</p>
            <p id="resumoCaixa"><b>Caixa:</b> 0</p>
            <p id="resumoRecepcao"><b>Recepção:</b> 0</p>
            <p id="resumoAdmin"><b>Administradores:</b> 0</p>
        </div>

        <!-- CADASTRO / EDIÇÃO -->
        <div class="card">
            <h2 id="tituloForm" style="color:var(--azul)">Cadastrar Novo Colaborador</h2>

            <input id="nome" placeholder="Nome completo">
            <input id="email" type="email" placeholder="Email do colaborador">
            <input id="senha" type="password" placeholder="Senha de acesso">

            <label><b>Nível de acesso:</b></label>
            <select id="nivel">
                <option value="cozinha">Cozinha</option>
                <option value="caixa">Caixa</option>
                <option value="admin">Administrador</option>
                <option value="recepcao">Recepção</option>
            </select>

            <button class="btn btn-primary" id="btnCadastrar">
                <i class="fas fa-user-plus"></i> <span id="textoBotao">Cadastrar Colaborador</span>
            </button>
        </div>

        <!-- LISTA -->
        <div class="card">
            <h2 style="color:var(--azul)">Colaboradores cadastrados</h2>

            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Acesso</th>
                        <th>Criado por</th>
                        <th>Ações</th>
                    </tr>
                </thead>

                <tbody id="tabelaColab"></tbody>
            </table>
        </div>

        <!-- LOGS -->
        <div class="card">
            <h2 style="color:var(--azul)">Atividades Recentes</h2>
            <ul id="listaLogs" style="max-height:220px; overflow-y:auto; padding-left:18px;"></ul>
        </div>

    </div>

</div>

<script type="module">
/* ================================
   IMPORTS FIREBASE
================================ */
import { auth, db } from "./firebase.js";
import { 
    onAuthStateChanged, 
    signOut,
    sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import { 
    ref, 
    push, 
    onValue, 
    remove,
    set
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

/* ================================
   PROTEÇÃO — SOMENTE ADMIN MASTER
================================ */
let usuarioAtualEmail = "";
let usuarioAtualUid = "";
let usuarioMaster = "raphael122362@gmail.com"; // email MASTER

onAuthStateChanged(auth, user => {
    if (!user) {
        window.location.href = "../login.html";
        return;
    }

    usuarioAtualEmail = user.email;
    usuarioAtualUid = user.uid;

    // se NÃO for o master → bloqueia página
    if (usuarioAtualEmail !== usuarioMaster) {
        document.getElementById("conteudoMaster").style.display = "none";
        document.getElementById("masterAviso").style.display = "block";
    }
});

/* SAIR */
window.logout = () => signOut(auth);

/* ================================
   VARIÁVEIS GLOBAIS
================================ */
let editId = null;
const colaboradoresCache = {};

/* ================================
   FUNÇÃO DE LOG
================================ */
function registrarLog(acao, colabEmail){
    push(ref(db, "logs_colaboradores"), {
        acao,
        colabEmail,
        feitoPor: usuarioAtualEmail || "desconhecido",
        data: Date.now()
    });
}

/* ================================
   CADASTRAR / EDITAR COLABORADOR
================================ */
document.getElementById("btnCadastrar").onclick = async ()=>{

    const nome = document.getElementById("nome").value.trim();
    const email = document.getElementById("email").value.trim();
    const senha = document.getElementById("senha").value.trim();
    const nivel = document.getElementById("nivel").value;
    const textoBotao = document.getElementById("textoBotao");
    const tituloForm = document.getElementById("tituloForm");

    if(!nome || !email || (!senha && !editId)){
        alert("Preencha os campos obrigatórios (nome, email e senha para novo cadastro)!");
        return;
    }

    try{
        // EDIÇÃO DE COLABORADOR
        if(editId){
            const antigo = colaboradoresCache[editId] || {};

            await set(ref(db, "colaboradores/" + editId), {
                nome,
                email: antigo.email,
                nivel,
                uid: antigo.uid || null,
                criadoPor: antigo.criadoPor || "",
                criadoEm: antigo.criadoEm || Date.now()
            });

            registrarLog("Edição de colaborador", antigo.email || email);
            alert("Colaborador atualizado com sucesso!");

            editId = null;
            textoBotao.textContent = "Cadastrar Colaborador";
            tituloForm.textContent = "Cadastrar Novo Colaborador";
            document.getElementById("senha").value = "";
            document.getElementById("email").disabled = false;

            limparFormularioBasico();
            return;
        }

        // NOVO COLABORADOR
        const response = await fetch(
            `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyCaFP_oX5Rj6Jfmssn-5Rh3uPdiY3S9A2g`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: email,
                    password: senha,
                    returnSecureToken: true
                })
            }
        );

        const data = await response.json();

        if(data.error){
            alert("Erro ao criar colaborador: " + data.error.message);
            console.error(data.error);
            return;
        }

        const uidCriado = data.localId;

        await push(ref(db, "colaboradores"), {
            nome,
            email,
            nivel,
            uid: uidCriado,
            criadoPor: usuarioAtualEmail,
            criadoEm: Date.now()
        });

        registrarLog("Cadastro de colaborador", email);
        alert("Colaborador cadastrado com sucesso!");
        limparFormularioBasico();

    }catch(e){
        console.error(e);
        alert("Erro inesperado ao cadastrar colaborador.");
    }
};

/* LIMPAR FORM BÁSICO */
function limparFormularioBasico(){
    document.getElementById("nome").value = "";
    document.getElementById("email").value = "";
    document.getElementById("senha").value = "";
    document.getElementById("nivel").value = "cozinha";
}

/* ================================
   LISTAR COLABORADORES + RESUMO
================================ */
const tabela = document.getElementById("tabelaColab");
const resumoTotal = document.getElementById("resumoTotal");
const resumoCozinha = document.getElementById("resumoCozinha");
const resumoCaixa = document.getElementById("resumoCaixa");
const resumoRecepcao = document.getElementById("resumoRecepcao");
const resumoAdmin = document.getElementById("resumoAdmin");

onValue(ref(db, "colaboradores"), snapshot => {

    tabela.innerHTML = "";
    Object.keys(colaboradoresCache).forEach(k => delete colaboradoresCache[k]);

    let total = 0;
    let coz = 0;
    let cax = 0;
    let rec = 0;
    let adm = 0;

    snapshot.forEach(item => {
        const c = item.val();
        const id = item.key;

        colaboradoresCache[id] = c;
        total++;

        if(c.nivel === "cozinha") coz++;
        else if(c.nivel === "caixa") cax++;
        else if(c.nivel === "recepcao") rec++;
        else if(c.nivel === "admin") adm++;

        const criadoPor = c.criadoPor || "-";
        const criadoEm  = c.criadoEm 
            ? new Date(c.criadoEm).toLocaleString("pt-BR")
            : "-";

        tabela.innerHTML += `
            <tr>
                <td>${c.nome}</td>
                <td>${c.email}</td>
                <td>${c.nivel}</td>
                <td>
                    <div>${criadoPor}</div>
                    <small>${criadoEm}</small>
                </td>
                <td>
                    <button class="btn btn-primary" style="margin-right:5px;"
                        onclick="editarColab('${id}')">
                        <i class="fas fa-pen"></i>
                    </button>

                    <button class="btn btn-warning" style="margin-right:5px;"
                        onclick="resetSenha('${c.email}')">
                        <i class="fas fa-key"></i>
                    </button>

                    <button class="btn btn-danger"
                        onclick="excluir('${id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    resumoTotal.innerHTML   = `<b>Total:</b> ${total}`;
    resumoCozinha.innerHTML = `<b>Cozinha:</b> ${coz}`;
    resumoCaixa.innerHTML   = `<b>Caixa:</b> ${cax}`;
    resumoRecepcao.innerHTML= `<b>Recepção:</b> ${rec}`;
    resumoAdmin.innerHTML   = `<b>Administradores:</b> ${adm}`;
});

/* ================================
   EDITAR COLABORADOR
================================ */
window.editarColab = id => {
    const c = colaboradoresCache[id];
    if(!c) return;

    editId = id;
    document.getElementById("nome").value  = c.nome;
    document.getElementById("email").value = c.email;
    document.getElementById("email").disabled = true;
    document.getElementById("senha").value = "";
    document.getElementById("nivel").value = c.nivel || "cozinha";

    document.getElementById("tituloForm").textContent = "Editar Colaborador";
    document.getElementById("textoBotao").textContent = "Salvar Alterações";
};

/* ================================
   REDEFINIR SENHA (envia e-mail)
================================ */
window.resetSenha = async (email) => {
    if(!confirm(`Enviar e-mail de redefinição para ${email}?`)) return;

    try{
        await sendPasswordResetEmail(auth, email);
        registrarLog("Reset de senha solicitado", email);
        alert("Email de redefinição enviado (se o email existir e estiver configurado).");
    }catch(e){
        console.error(e);
        alert("Erro ao enviar email de redefinição.");
    }
};

/* ================================
   EXCLUIR COLABORADOR (DB)
================================ */
window.excluir = id =>{
    const c = colaboradoresCache[id];
    const email = c ? c.email : "";

    if(confirm("Deseja excluir este colaborador do banco de dados? Isso não remove o login Firebase.")){
        remove(ref(db, "colaboradores/" + id));
        registrarLog("Exclusão de colaborador", email);
    }
};

/* ================================
   LOGS (AUDITORIA)
================================ */
const listaLogs = document.getElementById("listaLogs");

onValue(ref(db, "logs_colaboradores"), snapshot => {
    listaLogs.innerHTML = "";

    const logsTemp = [];

    snapshot.forEach(item => {
        logsTemp.push(item.val());
    });

    logsTemp.sort((a,b)=> (b.data || 0) - (a.data || 0));

    logsTemp.slice(0,30).forEach(log => {
        const dataStr = log.data 
            ? new Date(log.data).toLocaleString("pt-BR")
            : "-";

        const li = document.createElement("li");
        li.innerHTML = `<b>${log.acao}</b> - ${log.colabEmail || "-"} 
            <br><small>por ${log.feitoPor || "-"} em ${dataStr}</small>`;
        listaLogs.appendChild(li);
    });
});

</script>

<script>
function go(p){ window.location.href = p; }
function toggleMenu(){ document.getElementById("sidebar").classList.toggle("active"); }
</script>

</body>
</html>
