<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Produtos - Mava Baristro</title>

<link rel="stylesheet" href="admin.css">
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* Só um ajuste visual específico da página */
.btn-edit{
    background:var(--dourado);
    color:white;
    margin-right:8px;
}
.prod-img{
    width:110px;
    height:110px;
    object-fit:cover;
    border-radius:10px;
}
.prod-linha{
    display:flex;
    gap:18px;
    padding:14px;
    border-radius:10px;
    background:#ffffff;
    margin-bottom:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
}
</style>
</head>

<body>

<!-- BOTÃO MENU MOBILE -->
<div class="menu-toggle" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">

    <h2>Mava Baristro</h2>

    <div class="menu-item" onclick="go('dashboard.html')">
        <i class="fas fa-chart-line"></i> Dashboard
    </div>

    <div class="menu-item" onclick="go('produtos.html')">
        <i class="fas fa-mug-hot"></i> Produtos
    </div>

    <div class="menu-item" onclick="go('colaboradores.html')">
        <i class="fas fa-users"></i> Colaboradores
    </div>

    <div class="menu-item" onclick="logout()">
        <i class="fas fa-door-open"></i> Sair
    </div>

</div>

<!-- CONTEÚDO PRINCIPAL -->
<div class="content">

    <h1 class="title">Gerenciar Produtos</h1>

    <!-- FORMULÁRIO -->
    <div class="card">
        <h2 id="titulo-form" style="color:var(--azul);margin-bottom:15px;">
            Cadastrar Produto
        </h2>

        <input id="nome" placeholder="Nome do produto">
        <input id="preco" placeholder="Preço (ex: 12.50)">
        <textarea id="descricao" placeholder="Descrição"></textarea>

        <select id="categoria">
            <option value="">Selecione a categoria</option>
            <option value="cafes">Cafés</option>
            <option value="bebidas">Bebidas</option>
            <option value="doces">Doces</option>
            <option value="salgados">Salgados</option>
        </select>

        <select id="quantidade">
            <option value="">Selecione a quantidade</option>
            <option value="200g">200g</option>
            <option value="500g">500g</option>
            <option value="1kg">1kg</option>
            <option value="200ml">200ml</option>
            <option value="500ml">500ml</option>
            <option value="600ml">600ml</option>
            <option value="700ml">700ml</option>
            <option value="1L">1L</option>
            <option value="2L">2L</option>
        </select>

        <label><b>Foto do produto:</b></label>
        <input type="file" id="foto" accept="image/*">

        <button class="btn btn-primary" id="btn-salvar">
            <i class="fas fa-save"></i> <span id="texto-botao">Cadastrar Produto</span>
        </button>
    </div>

    <!-- LISTA DE PRODUTOS -->
    <div class="card">
        <h2 style="color:var(--azul);margin-bottom:15px;">Produtos cadastrados</h2>
        <div id="listaProdutos"></div>
    </div>

</div>

<script type="module">
/* ============ IMPORTS FIREBASE ============ */
import { auth, db } from "./firebase.js";
import {
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import {
    ref,
    onValue,
    push,
    set,
    remove
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

/* ============ PROTEÇÃO ============ */
onAuthStateChanged(auth, user => {
    if (!user) window.location.href = "../login.html";
});

window.logout = () => signOut(auth);

/* ============ VARIÁVEIS GLOBAIS ============ */
let editId = null;
let fotoAtual = null;
const produtosCache = {};

const btnSalvar = document.getElementById("btn-salvar");
const textoBotao = document.getElementById("texto-botao");
const tituloForm = document.getElementById("titulo-form");

/* ============ FUNÇÃO BASE64 ============ */
function converterBase64(file){
    return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload  = ()=> resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
    });
}

/* ============ BOTÃO SALVAR / ATUALIZAR ============ */
btnSalvar.onclick = async () => {

    const nome       = document.getElementById("nome").value.trim();
    const preco      = document.getElementById("preco").value.trim();
    const descricao  = document.getElementById("descricao").value.trim();
    const categoria  = document.getElementById("categoria").value;
    const quantidade = document.getElementById("quantidade").value;
    const fotoFile   = document.getElementById("foto").files[0];

    if (!nome || !preco || !categoria){
        alert("Preencha pelo menos Nome, Preço e Categoria.");
        return;
    }

    try{
        let base64;

        if(editId){  // Atualização
            if(fotoFile){
                base64 = await converterBase64(fotoFile);
            }else{
                base64 = fotoAtual; // mantém foto antiga
            }

            await set(ref(db, "produtos/" + editId), {
                nome,
                preco,
                descricao,
                categoria,
                quantidade,
                foto: base64
            });

            alert("Produto atualizado com sucesso!");
        }else{       // Novo cadastro
            if(!fotoFile){
                alert("Selecione a foto do produto!");
                return;
            }

            base64 = await converterBase64(fotoFile);

            await push(ref(db, "produtos"), {
                nome,
                preco,
                descricao,
                categoria,
                quantidade,
                foto: base64
            });

            alert("Produto cadastrado com sucesso!");
        }

        limparFormulario();

    }catch(erro){
        console.error(erro);
        alert("Erro ao salvar o produto. Veja o console.");
    }
};

/* ============ LIMPAR FORMULÁRIO ============ */
function limparFormulario(){
    document.getElementById("nome").value = "";
    document.getElementById("preco").value = "";
    document.getElementById("descricao").value = "";
    document.getElementById("categoria").value = "";
    document.getElementById("quantidade").value = "";
    document.getElementById("foto").value = "";

    editId = null;
    fotoAtual = null;
    textoBotao.textContent = "Cadastrar Produto";
    tituloForm.textContent = "Cadastrar Produto";
}

/* ============ LISTAR PRODUTOS ============ */
const lista = document.getElementById("listaProdutos");

onValue(ref(db, "produtos"), snapshot => {
    lista.innerHTML = "";
    Object.keys(produtosCache).forEach(k => delete produtosCache[k]);

    snapshot.forEach(item => {
        const p  = item.val();
        const id = item.key;
        produtosCache[id] = p;

        lista.innerHTML += `
            <div class="prod-linha">
                <img class="prod-img" src="${p.foto}" alt="${p.nome}">
                <div style="flex:1;">
                    <h3 style="margin-bottom:6px;color:var(--azul);">${p.nome}</h3>
                    <p><b>Preço:</b> R$ ${p.preco}</p>
                    <p><b>Categoria:</b> ${p.categoria}</p>
                    <p><b>Quantidade:</b> ${p.quantidade || "-"}</p>
                    <p><b>Descrição:</b> ${p.descricao || "-"}</p>
                    <div style="margin-top:10px;">
                        <button class="btn btn-edit" onclick="editarProduto('${id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-danger" onclick="excluirProduto('${id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
});

/* ============ EDITAR PRODUTO ============ */
window.editarProduto = (id) => {
    const p = produtosCache[id];
    if(!p) return;

    editId = id;
    fotoAtual = p.foto;

    document.getElementById("nome").value        = p.nome;
    document.getElementById("preco").value       = p.preco;
    document.getElementById("descricao").value   = p.descricao || "";
    document.getElementById("categoria").value   = p.categoria || "";
    document.getElementById("quantidade").value  = p.quantidade || "";
    document.getElementById("foto").value        = "";

    textoBotao.textContent = "Atualizar Produto";
    tituloForm.textContent = "Editar Produto";

    window.scrollTo({ top:0, behavior:"smooth" });
};

/* ============ EXCLUIR PRODUTO ============ */
window.excluirProduto = (id) => {
    if(confirm("Deseja realmente excluir este produto?")){
        remove(ref(db, "produtos/" + id));
    }
};
</script>

<script>
function go(p){ window.location.href = p; }
function toggleMenu(){ document.getElementById("sidebar").classList.toggle("active"); }
</script>

</body>
</html>
