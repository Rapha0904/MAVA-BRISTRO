<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cardápio - Mava Baristro</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* ================= PALETA ================= */
:root{
    --azul:#0a0f2e;
    --dourado:#b88a55;
    --gold-light:#d4b37a;
    --cinza:#f4f4f4;
    --branco:#ffffff;
}

/* ================= GLOBAL ================= */
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:Arial, sans-serif;
}
body{
    background:var(--cinza);
    overflow-x:hidden;
}

/* ============== TELA BLOQUEADA ============== */
#telaBloqueada{
    position:fixed;
    inset:0;
    background:white;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:20px;
    z-index:999999;
    font-size:18px;
    color:var(--azul);
}
#telaBloqueada h2{
    margin-bottom:10px;
    color:var(--dourado);
    font-size:26px;
}
#telaBloqueada button{
    margin-top:20px;
    padding:10px 18px;
    border:none;
    background:var(--azul);
    color:var(--dourado);
    border-radius:10px;
    font-size:16px;
    font-weight:bold;
    cursor:pointer;
}

/* ================= HEADER PRINCIPAL ================= */
header{
    background:var(--azul);
    color:white;
    padding:15px 22px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:4px solid var(--dourado);
}

header .left{
    display:flex;
    align-items:center;
    gap:14px;
}

header img{
    width:65px;
    height:65px;
    border-radius:50%;
    border:3px solid var(--dourado);
}

header h1{
    font-size:24px;
    font-weight:bold;
}

/* ============ BARRA SUPERIOR (MESA + CARRINHO) ============ */
.top-info{
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:white;
    padding:12px 22px;
    border-bottom:3px solid var(--dourado);
}

.mesa-info{
    background:var(--dourado);
    padding:8px 16px;
    border-radius:12px;
    font-size:18px;
    font-weight:bold;
    color:white;
    box-shadow:0 3px 10px rgba(0,0,0,0.25);
}

.carrinho-btn{
    width:58px;
    height:58px;
    border-radius:50%;
    background:var(--dourado);
    color:white;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.25);
}

/* ================= NAV ================= */
.nav{
    background:white;
    display:flex;
    justify-content:center;
    gap:25px;
    padding:14px;
    border-bottom:3px solid var(--dourado);
}

.nav button{
    background:none;
    border:none;
    font-size:17px;
    font-weight:bold;
    color:var(--azul);
    cursor:pointer;
    padding:5px 10px;
}

.nav button.active{
    border-bottom:3px solid var(--dourado);
    color:var(--dourado);
}

/* ================= GRID ================= */
.menu-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(190px, 1fr));
    gap:22px;
    padding:20px;
}

/* ================= CARD ================= */
.card{
    background:#ffffff;
    border-radius:16px;
    padding:14px;
    box-shadow:0 3px 10px rgba(0,0,0,0.12);
    border:3px solid var(--dourado);
    text-align:center;
    transition:.25s;
}

.card:hover{
    transform:translateY(-4px);
    box-shadow:0 6px 16px rgba(0,0,0,0.18);
    border-color:var(--gold-light);
}

.card img{
    width:100%;
    height:150px;
    object-fit:cover;
    border-radius:12px;
}

.card h3{
    margin-top:10px;
    font-size:18px;
    font-weight:bold;
    color:var(--azul);
}

.card .preco{
    margin-top:4px;
    font-size:17px;
    font-weight:bold;
    color:var(--azul);
}

/* ================= BOTÃO ================= */
.add-btn{
    margin-top:12px;
    background:var(--azul);
    color:var(--dourado);
    border:none;
    width:100%;
    padding:10px 0;
    border-radius:10px;
    font-size:15px;
    font-weight:bold;
    cursor:pointer;
    transition:.25s;
}

.add-btn:hover{
    background:#0f173e;
}

/* ================= CARRINHO ================= */
#carrinho{
    position:fixed;
    top:0;
    right:0;
    width:340px;
    background:white;
    height:100vh;
    border-left:4px solid var(--dourado);
    padding:20px;
    transform:translateX(100%);
    transition:.4s;
    overflow-y:auto;
    z-index:999;
}

#lista-itens li{
    background:#f4f4f4;
    padding:10px;
    margin-bottom:8px;
    border-radius:8px;
    font-size:14px;
}

.confirmar-btn{
    background:var(--azul);
    color:var(--dourado);
    width:100%;
    padding:14px;
    font-size:17px;
    border:none;
    border-radius:12px;
    margin-top:15px;
    cursor:pointer;
}
</style>
</head>

<body>

<!-- ================= BLOQUEIO DA PÁGINA ================= -->
<div id="telaBloqueada" style="display:none;">
    <h2 id="bloqTitulo"></h2>
    <p id="bloqMsg"></p>
    <button onclick="window.location.reload()">Atualizar</button>
</div>

<!-- ================= HEADER PRINCIPAL ================= -->
<header>
    <div class="left">
        <img src="logo_mava_baristro.png">
        <h1>Mava Baristro</h1>
    </div>
</header>

<!-- ================= BARRA SUPERIOR ================= -->
<div class="top-info">
    <div class="mesa-info" id="mesaInfo">Carregando...</div>

    <div id="btn-carrinho" class="carrinho-btn">
        <i class="fas fa-shopping-cart"></i>
    </div>
</div>

<!-- NAV -->
<div class="nav">
    <button class="active" data-cat="cafes">Cafés</button>
    <button data-cat="bebidas">Bebidas</button>
    <button data-cat="doces">Doces</button>
    <button data-cat="salgados">Salgados</button>
</div>

<div class="menu-grid" id="grid"></div>

<!-- ================= CARRINHO ================= -->
<div id="carrinho">
    <h2>Carrinho</h2>
    <ul id="lista-itens"></ul>
    <h3 id="total">Total: R$ 0,00</h3>
    <button class="confirmar-btn" id="confirmar">Confirmar Pedido</button>
</div>

<!-- ================= JS / FIREBASE ================= -->
<script type="module">

/* ====== PEGAR MESA DO QR ====== */
const params = new URLSearchParams(window.location.search);
const mesa = params.get("mesa") || "Mesa não encontrada";

/* ====== DEVICE ====== */
let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
    deviceId = "dev-" + Math.random().toString(36).substr(2,9);
    localStorage.setItem("deviceId", deviceId);
}

/* ====== FIREBASE ====== */
import { db } from "./ADMINISTRATIVO/firebase.js";
import { ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

/* ===== VERIFICAR STATUS DA MESA ===== */
let nomeCliente = null;

onValue(ref(db, "mesas/" + mesa), snap => {

    if (!snap.exists()){
        bloquear("Mesa não encontrada", "Chame o atendente.");
        return;
    }

    const dados = snap.val();

    if (dados.status === "livre"){
        bloquear("Mesa não está ocupada", "Chame o atendente para liberar.");
        return;
    }

    if (!dados.clientes || dados.clientes.length === 0){
        bloquear("Nenhum cliente cadastrado", "Chame o atendente.");
        return;
    }

    nomeCliente = dados.clientes[0];
    document.getElementById("mesaInfo").innerText =
        `Mesa ${mesa} — Bem-vindo, ${nomeCliente}`;

    liberarPagina();
});

/* =================== BLOQUEIOS ===================== */
function bloquear(titulo, msg){
    document.getElementById("bloqTitulo").innerText = titulo;
    document.getElementById("bloqMsg").innerText = msg;
    document.getElementById("telaBloqueada").style.display = "flex";
}

function liberarPagina(){
    document.getElementById("telaBloqueada").style.display = "none";
}

/* =================== CARRINHO ===================== */
document.getElementById("btn-carrinho").onclick = ()=>{
    const painel = document.getElementById("carrinho");
    painel.style.transform =
        painel.style.transform === "translateX(0%)"
        ? "translateX(100%)"
        : "translateX(0%)";
};

/* =================== PRODUTOS ===================== */
let categoriaAtual = "cafes";
const grid = document.getElementById("grid");

document.querySelectorAll(".nav button").forEach(btn=>{
    btn.onclick = ()=>{
        document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        categoriaAtual = btn.dataset.cat;
        carregarProdutos();
    };
});

function carregarProdutos(){
    onValue(ref(db,"produtos"), snap=>{
        grid.innerHTML = "";

        snap.forEach(item=>{
            const p = item.val();
            if(p.categoria !== categoriaAtual) return;

            grid.innerHTML += `
                <div class="card">
                    <img src="${p.foto}">
                    <h3>${p.nome}</h3>
                    <p class="preco">R$ ${p.preco}</p>

                    <button class="add-btn"
                     data-nome="${p.nome}"
                     data-preco="${p.preco}">
                        + Adicionar
                    </button>
                </div>
            `;
        });

        ativarBotoes();
    });
}
carregarProdutos();

/* =================== CARRINHO ===================== */
let total = 0;
const ul = document.getElementById("lista-itens");

function ativarBotoes(){
    document.querySelectorAll(".add-btn").forEach(btn=>{
        btn.onclick = ()=>{
            const nome = btn.dataset.nome;
            const preco = parseFloat(btn.dataset.preco);

            total += preco;
            document.getElementById("total").innerText =
                `Total: R$ ${total.toFixed(2)}`;

            const li = document.createElement("li");
            li.innerText = `${nome} — R$ ${preco.toFixed(2)}`;
            ul.appendChild(li);
        };
    });
}

/* =================== ENVIAR PEDIDO ===================== */
document.getElementById("confirmar").onclick = ()=>{

    if(!nomeCliente){
        alert("Mesa não está liberada para pedidos.");
        return;
    }

    const itens = [];
    ul.querySelectorAll("li").forEach(li=> itens.push(li.innerText));

    if(itens.length === 0){
        alert("Adicione itens antes de confirmar!");
        return;
    }

    const pedido = {
        mesa,
        nomeCliente,
        itens,
        total,
        status:"novo",
        hora:Date.now(),
        deviceId
    };

    push(ref(db,"pedidos"), pedido);

    alert("Pedido enviado!");
    location.reload();
};
</script>

</body>
</html>
